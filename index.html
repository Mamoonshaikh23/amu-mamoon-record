<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AMU Mamoon Record</title>

  <!-- PWA manifest -->
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#f57c00" />

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* small extra polish */
    .card { background: white; border-radius: 12px; box-shadow: 0 8px 24px rgba(15,23,42,0.06); }
    .muted { color: #6b7280; }
  </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans text-gray-800 p-4">

  <div class="max-w-3xl mx-auto">
    <header class="flex items-center justify-between mb-4">
      <div>
        <h1 class="text-2xl font-semibold">AMU Mamoon Record</h1>
        <div class="text-sm muted">Credit / Debit ledger â€” data stored locally</div>
      </div>
      <div class="text-right muted text-sm">Tip: Use Export/Quick Backup to save</div>
    </header>

    <section class="card p-4 mb-4">
      <form id="entryForm" class="grid grid-cols-1 md:grid-cols-5 gap-3 items-end">
        <div class="md:col-span-2">
          <label class="block text-sm muted mb-1">Name</label>
          <input id="name" class="w-full p-2 border rounded-md" placeholder="Person / Note" required />
        </div>

        <div>
          <label class="block text-sm muted mb-1">Type</label>
          <select id="type" class="w-full p-2 border rounded-md">
            <option value="credit">Credit (Received)</option>
            <option value="debit">Debit (Paid)</option>
          </select>
        </div>

        <div>
          <label class="block text-sm muted mb-1">Amount</label>
          <input id="amount" type="number" step="0.01" min="0" class="w-full p-2 border rounded-md" placeholder="0.00" required />
        </div>

        <div>
          <label class="block text-sm muted mb-1">Date</label>
          <input id="date" type="date" class="w-full p-2 border rounded-md" required />
        </div>

        <div class="md:col-span-5 flex gap-2 mt-1">
          <button type="submit" id="saveBtn" class="ml-auto px-4 py-2 rounded-md bg-orange-500 text-white">Add</button>
          <button type="button" id="clearForm" class="px-4 py-2 rounded-md border">Clear</button>
        </div>
      </form>

      <div class="mt-4 grid grid-cols-1 md:grid-cols-4 gap-3 items-center">
        <div class="col-span-2">
          <div class="flex gap-2">
            <input id="filterName" placeholder="Search name or note" class="flex-1 p-2 border rounded-md" />
            <input id="fromDate" type="date" class="p-2 border rounded-md" />
            <input id="toDate" type="date" class="p-2 border rounded-md" />
            <button id="clearFilter" class="px-3 py-2 border rounded-md">Clear</button>
          </div>
        </div>

        <div class="flex gap-2 justify-end md:col-span-2">
          <button id="exportCsv" class="px-3 py-2 rounded-md border">Export CSV</button>
          <label class="px-3 py-2 rounded-md border cursor-pointer">
            Import CSV
            <input id="importCsv" type="file" accept=".csv,text/csv" style="display:none" />
          </label>
          <button id="quickBackup" class="px-3 py-2 rounded-md bg-green-600 text-white">Quick Backup</button>
          <button id="clearAll" class="px-3 py-2 rounded-md bg-red-500 text-white">Clear All</button>
        </div>
      </div>

      <div class="mt-4 flex gap-3 flex-wrap">
        <div class="p-3 bg-gray-100 rounded-md w-full md:w-1/3">
          <div class="text-sm muted">Total Credit</div>
          <div id="totalCredit" class="text-lg font-semibold">0.00</div>
        </div>
        <div class="p-3 bg-gray-100 rounded-md w-full md:w-1/3">
          <div class="text-sm muted">Total Debit</div>
          <div id="totalDebit" class="text-lg font-semibold">0.00</div>
        </div>
        <div class="p-3 bg-gray-100 rounded-md w-full md:w-1/3">
          <div class="text-sm muted">Balance (Credit - Debit)</div>
          <div id="balance" class="text-lg font-semibold">0.00</div>
        </div>
      </div>
    </section>

    <section class="card p-3 mb-6">
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead>
            <tr class="text-left text-xs uppercase text-gray-600">
              <th class="px-3 py-2">Name</th>
              <th class="px-3 py-2">Type</th>
              <th class="px-3 py-2 text-right">Amount</th>
              <th class="px-3 py-2">Date</th>
              <th class="px-3 py-2">Actions</th>
            </tr>
          </thead>
          <tbody id="ledgerBody"></tbody>
        </table>
      </div>

      <div class="mt-3 flex justify-between items-center">
        <div class="text-sm muted">Showing entries (filtered)</div>
        <div class="flex gap-2 items-center">
          <button id="undoDelete" class="px-3 py-2 border rounded-md" disabled>Undo Delete</button>
          <div class="text-xs muted">Last saved locally</div>
        </div>
      </div>
    </section>

    <footer class="text-center muted text-sm mb-8">Pro tip: Export CSV regularly to backup on Drive/WhatsApp.</footer>
  </div>

  <script>
    // Storage key (keeps compatibility with your earlier version)
    const STORAGE_KEY = 'artifactLedger_v1';

    // Elements
    const form = document.getElementById('entryForm');
    const nameEl = document.getElementById('name');
    const typeEl = document.getElementById('type');
    const amountEl = document.getElementById('amount');
    const dateEl = document.getElementById('date');
    const saveBtn = document.getElementById('saveBtn');
    const ledgerBody = document.getElementById('ledgerBody');
    const filterName = document.getElementById('filterName');
    const fromDate = document.getElementById('fromDate');
    const toDate = document.getElementById('toDate');
    const clearFilter = document.getElementById('clearFilter');
    const totalCreditEl = document.getElementById('totalCredit');
    const totalDebitEl = document.getElementById('totalDebit');
    const balanceEl = document.getElementById('balance');
    const exportCsvBtn = document.getElementById('exportCsv');
    const importCsvInput = document.getElementById('importCsv');
    const clearAllBtn = document.getElementById('clearAll');
    const quickBackupBtn = document.getElementById('quickBackup');
    const undoDeleteBtn = document.getElementById('undoDelete');

    // State
    let entries = [];
    let editId = null;
    let lastDeleted = null; // { item, index }

    // Initialize date to today
    dateEl.value = new Date().toISOString().slice(0,10);

    // Load
    function loadEntries(){
      const raw = localStorage.getItem(STORAGE_KEY);
      entries = raw ? JSON.parse(raw) : [];
    }

    // Save
    function saveEntries(){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(entries));
      render();
    }

    // Add or Save
    form.addEventListener('submit', (e)=>{
      e.preventDefault();
      const name = nameEl.value.trim();
      const type = typeEl.value;
      const amount = parseFloat(amountEl.value);
      const date = dateEl.value;

      if(!name || !date || isNaN(amount)) return alert('Please complete the form correctly');

      if(editId){
        const i = entries.findIndex(x=>x.id === editId);
        if(i > -1){
          entries[i] = { ...entries[i], name, type, amount, date };
        }
        editId = null;
        saveBtn.textContent = 'Add';
      } else {
        entries.push({ id: Date.now().toString(), name, type, amount, date });
      }

      form.reset();
      dateEl.value = new Date().toISOString().slice(0,10);
      saveEntries();
    });

    // Render with filters
    function render(){
      ledgerBody.innerHTML = '';
      const filtered = applyFilters(entries).sort((a,b)=> new Date(b.date) - new Date(a.date));

      for(const row of filtered){
        const tr = document.createElement('tr');
        tr.className = 'border-b';
        tr.innerHTML = `
          <td class="px-3 py-2">${escapeHtml(row.name)}</td>
          <td class="px-3 py-2">${row.type}</td>
          <td class="px-3 py-2 text-right">${Number(row.amount).toFixed(2)}</td>
          <td class="px-3 py-2">${row.date}</td>
          <td class="px-3 py-2">
            <button class="px-2 py-1 mr-1 rounded bg-blue-600 text-white text-xs" onclick="editEntry('${row.id}')">Edit</button>
            <button class="px-2 py-1 rounded bg-red-500 text-white text-xs" onclick="deleteEntry('${row.id}')">Delete</button>
          </td>
        `;
        ledgerBody.appendChild(tr);
      }

      updateTotals(filtered);
    }

    // Filters
    function applyFilters(list){
      const q = filterName.value.trim().toLowerCase();
      const from = fromDate.value ? new Date(fromDate.value) : null;
      const to = toDate.value ? new Date(toDate.value) : null;
      return list.filter(r=>{
        if(q && !r.name.toLowerCase().includes(q)) return false;
        const d = new Date(r.date);
        if(from && d < from) return false;
        if(to && d > new Date(to.getFullYear(), to.getMonth(), to.getDate(),23,59,59)) return false;
        return true;
      });
    }

    // Totals (for filtered list)
    function updateTotals(list){
      let credit = 0, debit = 0;
      for(const r of list){
        if(r.type === 'credit') credit += Number(r.amount);
        else debit += Number(r.amount);
      }
      totalCreditEl.textContent = credit.toFixed(2);
      totalDebitEl.textContent = debit.toFixed(2);
      balanceEl.textContent = (credit - debit).toFixed(2);
    }

    // Edit
    window.editEntry = function(id){
      const item = entries.find(x=>x.id===id);
      if(!item) return;
      nameEl.value = item.name;
      typeEl.value = item.type;
      amountEl.value = item.amount;
      dateEl.value = item.date;
      editId = id;
      saveBtn.textContent = 'Save';
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Delete (stores lastDeleted)
    window.deleteEntry = function(id){
      if(!confirm('Delete this entry?')) return;
      const idx = entries.findIndex(x=>x.id===id);
      if(idx > -1){
        lastDeleted = { item: entries[idx], index: idx };
        entries.splice(idx, 1);
        undoDeleteBtn.disabled = false;
        saveEntries();
      }
    }

    // Undo Delete
    undoDeleteBtn.addEventListener('click', ()=>{
      if(lastDeleted){
        const idx = Math.min(lastDeleted.index, entries.length);
        entries.splice(idx, 0, lastDeleted.item);
        lastDeleted = null;
        undoDeleteBtn.disabled = true;
        saveEntries();
      }
    });

    // Escape HTML
    function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;') }

    // Filters events
    filterName.addEventListener('input', render);
    fromDate.addEventListener('change', render);
    toDate.addEventListener('change', render);
    clearFilter.addEventListener('click', ()=>{ filterName.value=''; fromDate.value=''; toDate.value=''; render(); });

    // CSV export (all entries)
    function toCSV(rows){
      const header = ['id','name','type','amount','date'];
      const lines = [header.join(',')];
      for(const r of rows){
        // quote name
        const name = `"${String(r.name).replace(/"/g,'""')}"`;
        lines.push([r.id, name, r.type, r.amount, r.date].join(','));
      }
      return lines.join('\n');
    }

    exportCsvBtn.addEventListener('click', ()=>{
      const csv = toCSV(entries);
      downloadBlob(csv, 'artifact_ledger.csv', 'text/csv');
    });

    // Quick backup (timestamped)
    quickBackupBtn.addEventListener('click', ()=>{
      const now = new Date();
      const stamp = now.toISOString().replace(/:/g,'').replace(/\..+/, '');
      const csv = toCSV(entries);
      downloadBlob(csv, `ledger-backup-${stamp}.csv`, 'text/csv');
    });

    // Helper to download
    function downloadBlob(content, filename, mime='text/plain'){
      const blob = new Blob([content], { type: mime });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    // Import CSV (supports quoted fields)
    importCsvInput.addEventListener('change', async (e)=>{
      const f = e.target.files[0]; if(!f) return;
      const text = await f.text();
      const lines = text.split(/\r?\n/).filter(Boolean);
      if(lines.length <= 1) return alert('No rows to import');
      const parsed = [];
      for(let i=1;i<lines.length;i++){
        const row = splitCsvLine(lines[i]);
        if(row.length < 5) continue;
        const id = row[0] || (Date.now().toString()+i);
        const name = row[1];
        const type = row[2];
        const amount = parseFloat(row[3]) || 0;
        const date = row[4];
        parsed.push({ id, name, type, amount, date });
      }
      if(!confirm(`Import ${parsed.length} rows? This will append to existing entries.`)) return;
      entries = entries.concat(parsed);
      saveEntries();
      importCsvInput.value = '';
    });

    // CSV split that handles quoted commas
    function splitCsvLine(line){
      // splits on commas not inside quotes
      const parts = line.match(/("([^"]|"")*"|[^,]+)(?=,|$)/g) || [];
      return parts.map(p=>{
        p = p.trim();
        if(p.startsWith('"') && p.endsWith('"')) p = p.slice(1,-1).replace(/""/g,'"');
        return p;
      });
    }

    // Clear all
    clearAllBtn.addEventListener('click', ()=>{
      if(!confirm('Clear all entries from this browser?')) return;
      entries = [];
      saveEntries();
    });

    // Clear form
    document.getElementById('clearForm').addEventListener('click', ()=>{
      form.reset();
      dateEl.value = new Date().toISOString().slice(0,10);
      editId = null; saveBtn.textContent = 'Add';
    });

    // Init
    loadEntries();
    render();

    // Register service worker (PWA)
    if('serviceWorker' in navigator){
      window.addEventListener('load', ()=> {
        navigator.serviceWorker.register('service-worker.js').catch(e => console.warn('SW failed', e));
      });
    }
  </script>

</body>
</html>
